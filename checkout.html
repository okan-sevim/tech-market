<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - TechMarket</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-wrapper">
                <div class="logo">
                    <a href="index.html">
                        <span class="logo-text">Tech<span class="highlight">Market</span></span>
                    </a>
                </div>
                
                <nav class="desktop-nav">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="products.html">Products</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </nav>
                
                <div class="header-icons">
                    <div class="search-icon" onclick="openSearchModal()">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="user-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="cart-icon">
                        <a href="cart.html">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-count">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Title -->
    <section class="page-title">
        <div class="container">
            <h1>Checkout</h1>
            <div class="breadcrumb">
                <a href="index.html">Home</a>
                <span>/</span>
                <a href="cart.html">Cart</a>
                <span>/</span>
                <span class="current">Checkout</span>
            </div>
        </div>
    </section>

    <!-- Checkout Section -->
    <section class="checkout-section">
        <div class="container">
            <div class="checkout-steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-name">Shipping</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-name">Payment</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-name">Review</div>
                </div>
            </div>
            
            <div class="checkout-container">
                <div class="checkout-form">
                    <!-- Shipping Form -->
                    <div class="checkout-step active" id="step-shipping">
                        <div class="checkout-section">
                            <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="firstName" required>
                                    <small class="error-message"></small>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="lastName" required>
                                    <small class="error-message"></small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" required>
                                <small class="error-message"></small>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" required>
                                <small class="error-message"></small>
                            </div>
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" id="address" required>
                                <small class="error-message"></small>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" required>
                                    <small class="error-message"></small>
                                </div>
                                <div class="form-group">
                                    <label for="state">State/Province</label>
                                    <input type="text" id="state">
                                    <small class="error-message"></small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="zip">Zip/Postal Code</label>
                                    <input type="text" id="zip" required>
                                    <small class="error-message"></small>
                                </div>
                                <div class="form-group">
                                    <label for="country">Country</label>
                                    <select id="country" required>
                                        <option value="" selected disabled>Select Country</option>
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="TR">Turkey</option>
                                    </select>
                                    <small class="error-message"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="checkout-section">
                            <h3><i class="fas fa-truck"></i> Shipping Method</h3>
                            <div class="form-group">
                                <!-- Standart Kargo -->
                                <div class="radio-option">
                                    <input type="radio" id="standard" name="shipping" value="standard" checked>
                                    <label for="standard">
                                        <!-- ::before ve ::after buraya gelecek (CSS ile) -->
                                        <div class="option-details">
                                            <span class="option-name">Standard Shipping</span>
                                            <span class="option-description">3-5 business days</span>
                                        </div>
                                        <div class="option-price">Free</div>
                                    </label>
                                </div>
                                <!-- Express Kargo -->
                                <div class="radio-option">
                                    <input type="radio" id="express" name="shipping" value="express">
                                    <label for="express">
                                        <!-- ::before ve ::after buraya gelecek (CSS ile) -->
                                        <div class="option-details">
                                            <span class="option-name">Express Shipping</span>
                                            <span class="option-description">1-2 business days</span>
                                        </div>
                                        <div class="option-price">$9.99</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="checkout-actions">
                            <a href="cart.html" class="back-to-cart"><i class="fas fa-arrow-left"></i> Back to Cart</a>
                            <button type="button" class="btn-primary" id="btn-to-payment">Continue to Payment</button>
                        </div>
                    </div>

                    <!-- Payment Form (GÜNCELLENMİŞ BÖLÜM) -->
                    <div class="checkout-step" id="step-payment">
                        <div class="checkout-section">
                            <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
                            <div class="form-group">
                                <!-- Kredi Kartı Seçeneği -->
                                <div class="radio-option payment-option">
                                    <input type="radio" id="creditCard" name="paymentMethod" value="creditCard" checked>
                                    <label for="creditCard">
                                        <div class="option-details">
                                            <span class="option-name">Credit Card</span>
                                            <span class="option-description">Pay with Visa, Mastercard, Amex</span>
                                        </div>
                                        <div class="payment-icons">
                                            <i class="fab fa-cc-visa"></i>
                                            <i class="fab fa-cc-mastercard"></i>
                                            <i class="fab fa-cc-amex"></i>
                                        </div>
                                    </label>
                                </div>
                                <!-- Kredi Kartı Formu (Başlangıçta Gizli) -->
                                <div id="creditCardForm" class="payment-form-details">
                                    <div class="form-group">
                                        <label for="cardNumber">Card Number</label>
                                        <input type="text" id="cardNumber" placeholder="•••• •••• •••• ••••" required>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="expiryDate">Expiry Date</label>
                                            <input type="text" id="expiryDate" placeholder="MM / YY" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="cvc">CVC</label>
                                            <input type="text" id="cvc" placeholder="•••" required>
                                        </div>
                                    </div>
                                </div>
                                <!-- // Kredi Kartı Formu Sonu -->

                                <!-- PayPal Seçeneği -->
                                <div class="radio-option payment-option">
                                    <input type="radio" id="paypal" name="paymentMethod" value="paypal">
                                    <label for="paypal">
                                        <div class="option-details">
                                            <span class="option-name">PayPal</span>
                                            <span class="option-description">Pay securely with your PayPal account</span>
                                        </div>
                                        <div class="payment-icons">
                                            <i class="fab fa-cc-paypal"></i>
                                        </div>
                                    </label>
                                </div>
                                <!-- // PayPal Seçeneği Sonu -->
                            </div>
                        </div>

                        <div class="checkout-section">
                            <h3><i class="fas fa-receipt"></i> Billing Address</h3>
                            <div class="form-group billing-address-toggle">
                                <input type="checkbox" id="sameAsShipping" name="sameAsShipping" checked>
                                <label for="sameAsShipping">Same as shipping address</label>
                            </div>
                            <!-- Fatura Adresi Formu (Başlangıçta Gizli) -->
                            <div id="billingAddressForm" class="billing-address-details" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="billingFirstName">First Name</label>
                                        <input type="text" id="billingFirstName">
                                    </div>
                                    <div class="form-group">
                                        <label for="billingLastName">Last Name</label>
                                        <input type="text" id="billingLastName">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="billingAddress">Address</label>
                                    <input type="text" id="billingAddress">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="billingCity">City</label>
                                        <input type="text" id="billingCity">
                                    </div>
                                    <div class="form-group">
                                        <label for="billingState">State/Province</label>
                                        <input type="text" id="billingState">
                                    </div>
                                </div>
                                 <div class="form-row">
                                    <div class="form-group">
                                        <label for="billingZip">Zip/Postal Code</label>
                                        <input type="text" id="billingZip">
                                    </div>
                                    <div class="form-group">
                                        <label for="billingCountry">Country</label>
                                        <select id="billingCountry">
                                            <option value="" selected disabled>Select Country</option>
                                            <option value="US">United States</option>
                                            <option value="CA">Canada</option>
                                            <option value="UK">United Kingdom</option>
                                            <option value="TR">Turkey</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                             <!-- // Fatura Adresi Formu Sonu -->
                        </div>

                        <div class="checkout-actions">
                             <!-- Önceki Back Butonu burada -->
                            <button type="button" class="btn-secondary back-btn" onclick="navigateToStep('step-shipping')">Back to Shipping</button>
                             <!-- Continue to Review Butonu burada -->
                            <button type="button" class="btn-primary" id="btn-to-review">Continue to Review</button>
                        </div>
                    </div>

                    <!-- Review Order -->
                    <div class="checkout-step" id="step-review">
                        <div class="checkout-section">
                            <h3><i class="fas fa-clipboard-check"></i> Review Your Order</h3>
                            <p>Please review your order details before placing the order.</p>
                        </div>
                        <div class="checkout-actions">
                            <button type="button" class="btn-secondary back-btn" onclick="navigateToStep('step-payment')">Back to Payment</button>
                            <button type="submit" class="btn-primary" id="btn-place-order">Place Order</button>
                        </div>
                    </div>
                </div>
                
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-products" id="summary-products">
                        <!-- Will be populated by JS -->
                    </div>
                    <div class="summary-item">
                        <div class="label">Subtotal</div>
                        <div class="price" id="summary-subtotal">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Shipping</div>
                        <div class="price" id="summary-shipping">Free</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Tax</div>
                        <div class="price" id="summary-tax">$0.00</div>
                    </div>
                    <div class="summary-total">
                        <div class="label">Total</div>
                        <div class="price" id="summary-total">$0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <footer>
            <div class="container">
                <div class="footer-top">
                    <div class="footer-column">
                        <div class="logo">
                            <span class="logo-text">Tech<span class="highlight">Market</span></span>
                        </div>
                        <p>Your one-stop shop for the latest technology products and accessories that enhance your digital lifestyle.</p>
                        <div class="social-icons">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-instagram"></i></a>
                            <a href="#"><i class="fab fa-youtube"></i></a>
                        </div>
                    </div>
                    <div class="footer-column">
                        <h3>Shop</h3>
                        <ul>
                            <li><a href="products.html">All Products</a></li>
                            <li><a href="products.html?category=phones">Smartphones</a></li>
                            <li><a href="products.html?category=laptops">Laptops</a></li>
                            <li><a href="products.html?category=headphones">Headphones</a></li>
                            <li><a href="products.html?category=monitors">Monitors</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul>
                            <li><a href="#">Contact Us</a></li>
                            <li><a href="#">FAQ</a></li>
                            <li><a href="#">Shipping & Returns</a></li>
                            <li><a href="#">Warranty</a></li>
                            <li><a href="#">Repair Services</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Subscribe</h3>
                        <p>Get updates on our latest products and exclusive offers.</p>
                        <div class="newsletter-form">
                            <input type="email" placeholder="Your email" required>
                            <button type="submit"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <div class="copyright">
                        <p>&copy; 2023 TechMarket. All rights reserved.</p>
                    </div>
                    <div class="payment-methods">
                        <i class="fab fa-cc-visa"></i>
                        <i class="fab fa-cc-mastercard"></i>
                        <i class="fab fa-cc-amex"></i>
                        <i class="fab fa-cc-paypal"></i>
                        <i class="fab fa-cc-apple-pay"></i>
                    </div>
                </div>
            </div>
        </footer><!-- Footer içeriğinizi buraya ekleyin -->
    </footer>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Globals ---
            const cart = JSON.parse(localStorage.getItem('techMarketCart')) || [];
            const shippingCosts = { standard: 0, express: 9.99 };
            const taxRate = 0.10; // %10 Vergi oranı

            // --- Element Seçimleri ---
            // Adımlar
            const steps = document.querySelectorAll('.checkout-step');
            const stepIndicators = document.querySelectorAll('.checkout-steps .step');
            // Butonlar
            const btnToPayment = document.getElementById('btn-to-payment');
            const btnToReview = document.getElementById('btn-to-review');
            const btnPlaceOrder = document.getElementById('btn-place-order');
            const btnBackToShipping = document.querySelector('#step-payment .back-btn'); // CSS seçici ile seçtik
            const btnBackToPayment = document.querySelector('#step-review .back-btn');  // CSS seçici ile seçtik
            // Form Alanları
            const shippingOptions = document.querySelectorAll('input[name="shipping"]');
            const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');
            const creditCardForm = document.getElementById('creditCardForm');
            const sameAsShippingCheckbox = document.getElementById('sameAsShipping');
            const billingAddressForm = document.getElementById('billingAddressForm');
            // Sipariş Özeti Alanları
            const summaryProducts = document.getElementById('summary-products');
            const summarySubtotalEl = document.getElementById('summary-subtotal');
            const summaryShippingEl = document.getElementById('summary-shipping');
            const summaryTaxEl = document.getElementById('summary-tax');
            const summaryTotalEl = document.getElementById('summary-total');
            // Review Alanları
            const reviewShippingAddressEl = document.getElementById('review-shipping-address');
            const reviewPaymentMethodEl = document.getElementById('review-payment-method');

            // --- Durum Değişkenleri ---
            let currentShippingCost = shippingCosts.standard; // Başlangıçta standart seçili

            // --- Fonksiyonlar ---

            // Sipariş Özeti Güncelleme
            function updateOrderSummary() {
                // Element kontrolü
                 if (!summaryProducts || !summarySubtotalEl || !summaryShippingEl || !summaryTaxEl || !summaryTotalEl) {
                     console.error("Sipariş özeti elementleri bulunamadı!");
                     return;
                 }

                let currentSubtotal = 0;
                summaryProducts.innerHTML = ''; // Önce temizle

                if (cart.length === 0) {
                    summaryProducts.innerHTML = '<p style="color: rgba(255,255,255,0.6); font-size: 0.9em;">Your cart is empty.</p>';
                } else {
                    cart.forEach(item => {
                        const itemPrice = parseFloat(item.price) || 0;
                        const quantity = parseInt(item.quantity) || 0;
                        if (isNaN(itemPrice) || isNaN(quantity)) return; // Geçersizse atla
                        const itemTotal = itemPrice * quantity;
                        currentSubtotal += itemTotal;

                        const productDiv = document.createElement('div');
                        productDiv.classList.add('summary-product');
                        productDiv.innerHTML = `
                            <div class="summary-product-image">
                                <img src="${item.image || 'images/placeholder.png'}" alt="${item.name || 'Product'}">
                            </div>
                            <div class="summary-product-info">
                                <div class="summary-product-name">${item.name || 'Unknown Product'}</div>
                                <div class="summary-product-qty">Qty: ${quantity}</div>
                            </div>
                            <div class="summary-product-total">$${itemTotal.toFixed(2)}</div>
                        `;
                        summaryProducts.appendChild(productDiv);
                    });
                }

                const tax = currentSubtotal * taxRate;
                const total = currentSubtotal + tax + currentShippingCost;

                summarySubtotalEl.textContent = `$${currentSubtotal.toFixed(2)}`;
                summaryShippingEl.textContent = currentShippingCost === 0 ? 'Free' : `$${currentShippingCost.toFixed(2)}`;
                summaryTaxEl.textContent = `$${tax.toFixed(2)}`;
                summaryTotalEl.textContent = `$${total.toFixed(2)}`;
            }

            // Adımlar Arası Geçiş
            function navigateToStep(targetStepId) {
                steps.forEach(step => step.classList.remove('active'));
                const targetStep = document.getElementById(targetStepId);
                if (targetStep) targetStep.classList.add('active');

                // Adım Göstergelerini Güncelle
                let activeStepIndex = 0;
                if (targetStepId === 'step-payment') activeStepIndex = 1;
                else if (targetStepId === 'step-review') activeStepIndex = 2;

                stepIndicators.forEach((indicator, index) => {
                    if (index <= activeStepIndex) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                });
            }

            // Review Adımını Doldurma
            function populateReviewStep() {
                 // 1. Kargo Adresini Al ve Göster
                 if (reviewShippingAddressEl) {
                     const firstName = document.getElementById('firstName')?.value || '';
                     const lastName = document.getElementById('lastName')?.value || '';
                     const email = document.getElementById('email')?.value || '';
                     const phone = document.getElementById('phone')?.value || '';
                     const address = document.getElementById('address')?.value || '';
                     const city = document.getElementById('city')?.value || '';
                     const state = document.getElementById('state')?.value || '';
                     const zip = document.getElementById('zip')?.value || '';
                     const countrySelect = document.getElementById('country');
                     const country = countrySelect ? countrySelect.options[countrySelect.selectedIndex]?.text : '';
                     const selectedShippingInput = document.querySelector('input[name="shipping"]:checked');
                     const shippingMethod = selectedShippingInput ? selectedShippingInput.closest('.radio-option').querySelector('.option-name').textContent : 'Not Selected';

                     reviewShippingAddressEl.innerHTML = `
                         <p><strong>Name:</strong> ${firstName} ${lastName}</p>
                         <p><strong>Email:</strong> ${email}</p>
                         <p><strong>Phone:</strong> ${phone}</p>
                         <p><strong>Address:</strong> ${address}, ${city}, ${state} ${zip}, ${country}</p>
                         <p><strong>Shipping Method:</strong> ${shippingMethod}</p>
                     `;
                 }

                 // 2. Ödeme Yöntemini Al ve Göster
                 if (reviewPaymentMethodEl) {
                     const selectedPaymentInput = document.querySelector('input[name="paymentMethod"]:checked');
                     let paymentMethodText = 'Not Selected';
                     if (selectedPaymentInput) {
                         const paymentLabel = selectedPaymentInput.closest('.payment-option')?.querySelector('.option-name');
                         if(paymentLabel) paymentMethodText = paymentLabel.textContent;
                         if (selectedPaymentInput.value === 'creditCard') {
                             const cardNumber = document.getElementById('cardNumber')?.value || '';
                             const maskedCardNumber = cardNumber.length > 4 ? `**** **** **** ${cardNumber.slice(-4)}` : 'Invalid Card Number';
                             paymentMethodText += ` (${maskedCardNumber})`;
                         }
                     }
                     reviewPaymentMethodEl.innerHTML = `<p>${paymentMethodText}</p>`;
                 }
            }

            // Siparişi Tamamlama
            function placeOrder() {
                // Sipariş gönderme işlemleri (sunucuya istek vb.)
                console.log("Placing order...");
                // Simülasyon
                alert('Order Placed Successfully! (Simulated)');
                localStorage.removeItem('techMarketCart'); // Sepeti temizle
                updateOrderSummary(); // Özeti temizle (boş sepet mesajı gelir)
                updateCartCount([]); // Header'daki sayıyı sıfırla (main.js'den import edilmeli veya burada tanımlanmalı)
                // window.location.href = 'order-confirmation.html'; // Onay sayfasına yönlendir
                // Şimdilik ilk adıma dönelim
                navigateToStep('step-shipping');
            }

             // Header Sepet Sayısını Güncelleme (main.js'de varsa oradan kullanmak daha iyi)
             function updateCartCount(cart) {
                 const totalItems = cart.reduce((total, item) => total + (item.quantity || 0), 0);
                 document.querySelectorAll('.cart-count').forEach(el => {
                     el.textContent = totalItems;
                 });
             }

            // --- Doğrulama Yardımcı Fonksiyonları ---
            function setError(element, message) {
                const formGroup = element.closest('.form-group'); // En yakın .form-group'u bul
                const errorDisplay = formGroup?.querySelector('.error-message'); // Hata mesajı alanını bul
                if(formGroup) formGroup.classList.add('error'); // Hata class'ı ekle
                if(errorDisplay) errorDisplay.textContent = message; // Mesajı yaz
            }

            function clearError(element) {
                const formGroup = element.closest('.form-group');
                const errorDisplay = formGroup?.querySelector('.error-message');
                if(formGroup) formGroup.classList.remove('error');
                 if(errorDisplay) errorDisplay.textContent = ''; // Mesajı temizle
            }

            function isValidEmail(email) {
                // Basit email format kontrolü
                const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(String(email).toLowerCase());
            }

            // --- Kargo Formu Doğrulama Fonksiyonu ---
            function validateShippingForm() {
                let isValid = true; // Başlangıçta form geçerli kabul edilir

                // Alanları Seç
                const firstName = document.getElementById('firstName');
                const lastName = document.getElementById('lastName');
                const email = document.getElementById('email');
                const phone = document.getElementById('phone');
                const address = document.getElementById('address');
                const city = document.getElementById('city');
                const zip = document.getElementById('zip');
                const country = document.getElementById('country');
                // Opsiyonel alanlar için de seçici eklenebilir (örn: state)

                 // Tüm gerekli alanları bir diziye koyalım
                 const requiredFields = [firstName, lastName, email, phone, address, city, zip, country];

                 // 1. Boş Alan Kontrolü
                 requiredFields.forEach(field => {
                     if(field){ // Element varsa kontrol et
                        clearError(field); // Önce eski hataları temizle
                        if (field.value.trim() === '') {
                            setError(field, 'This field is required.');
                            isValid = false;
                        }
                     }
                 });

                // 2. Email Format Kontrolü
                 if (email && email.value.trim() !== '' && !isValidEmail(email.value.trim())) {
                     clearError(email); // Önceki hatayı temizle (boş değilse)
                     setError(email, 'Please enter a valid email address.');
                     isValid = false;
                 }

                 // 3. Diğer Kontroller (Opsiyonel - Telefon, Zip vb.)
                 // Örneğin basit bir zip kodu kontrolü (sadece sayı, 5 karakter varsayımı):
                 if (zip && zip.value.trim() !== '' && !/^\d{5}$/.test(zip.value.trim())) {
                      clearError(zip);
                      // setError(zip, 'Please enter a valid 5-digit zip code.');
                      // isValid = false; // Şimdilik sadece örnek, hata vermeyebiliriz
                 }

                return isValid; // Form geçerliyse true, değilse false döner
            }

            // --- Ödeme Formu Doğrulama Fonksiyonu ---
            function validatePaymentForm() {
                let isValid = true;
                const creditCardSelected = document.getElementById('creditCard')?.checked;

                // Sadece kredi kartı seçiliyse doğrula
                if (creditCardSelected) {
                    const cardNumber = document.getElementById('cardNumber');
                    const expiryDate = document.getElementById('expiryDate');
                    const cvc = document.getElementById('cvc');
                    const paymentFields = [cardNumber, expiryDate, cvc];

                    // 1. Boş Alan Kontrolü
                    paymentFields.forEach(field => {
                        if(field) { // Element varsa kontrol et
                            clearError(field); // Önceki hataları temizle
                            if (field.value.trim() === '') {
                                setError(field, 'This field is required.');
                                isValid = false;
                            }
                        }
                    });

                     // 2. Kart Numarası Formatı (Basit Kontrol - Sadece Sayı ve Uzunluk)
                     if (cardNumber && cardNumber.value.trim() !== '' && !/^\d{13,19}$/.test(cardNumber.value.replace(/\s/g, ''))) {
                         // Boşlukları kaldırıp sadece sayı ve 13-19 hane arası kontrolü
                         clearError(cardNumber);
                         setError(cardNumber, 'Please enter a valid card number.');
                         isValid = false;
                     }

                     // 3. Son Kullanma Tarihi Formatı (MM / YY)
                     if (expiryDate && expiryDate.value.trim() !== '' && !/^(0[1-9]|1[0-2])\s?\/\s?\d{2}$/.test(expiryDate.value.trim())) {
                         clearError(expiryDate);
                         setError(expiryDate, 'Please use MM / YY format.');
                         isValid = false;
                     }
                     // İsteğe bağlı: Geçmiş tarih kontrolü de eklenebilir

                     // 4. CVC Formatı (3 veya 4 Hane Sayı)
                     if (cvc && cvc.value.trim() !== '' && !/^\d{3,4}$/.test(cvc.value.trim())) {
                         clearError(cvc);
                         setError(cvc, 'Please enter a valid CVC (3 or 4 digits).');
                         isValid = false;
                     }
                }
                // PayPal veya başka bir yöntem seçiliyse, bu fonksiyon şimdilik her zaman true dönecek
                // İleride PayPal vb. için ek kontroller eklenebilir.

                // Fatura adresi checkbox'ı işaretli değilse, fatura adresini de doğrula
                if (!document.getElementById('sameAsShipping')?.checked) {
                     if (!validateBillingForm()) { // Ayrı bir fatura doğrulama fonksiyonu çağır
                          isValid = false;
                     }
                }

                return isValid;
            }

            // --- Fatura Adresi Doğrulama Fonksiyonu (GEREKLİ) ---
            function validateBillingForm() {
                 let isValid = true;
                 // Fatura adresi alanlarını seç
                 const billingFirstName = document.getElementById('billingFirstName');
                 const billingLastName = document.getElementById('billingLastName');
                 const billingAddress = document.getElementById('billingAddress');
                 const billingCity = document.getElementById('billingCity');
                 const billingZip = document.getElementById('billingZip');
                 const billingCountry = document.getElementById('billingCountry');
                 // Gerekli fatura alanları
                 const requiredBillingFields = [billingFirstName, billingLastName, billingAddress, billingCity, billingZip, billingCountry];

                 requiredBillingFields.forEach(field => {
                      if(field){
                           clearError(field);
                           if(field.value.trim() === ''){
                                setError(field, 'This field is required for billing.');
                                isValid = false;
                           }
                      }
                 });
                 // Burada da email, zip formatı gibi ek kontroller yapılabilir.
                 return isValid;
            }

            // --- Olay Dinleyicileri (Event Listeners) ---

            // Kargo Seçenekleri
            shippingOptions.forEach(option => {
                option.addEventListener('change', function() {
                    currentShippingCost = shippingCosts[this.value] || 0;
                    updateOrderSummary(); // Kargo değişince özeti güncelle
                });
            });

            // Ödeme Yöntemi Seçenekleri
            if(creditCardForm) { // Element varsa kontrol et
                paymentMethodRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        creditCardForm.style.display = (this.value === 'creditCard' && this.checked) ? 'block' : 'none';
                    });
                });
                // Başlangıç durumu
                creditCardForm.style.display = document.getElementById('creditCard')?.checked ? 'block' : 'none';
            }


            // Fatura Adresi Checkbox'ı
            if (sameAsShippingCheckbox && billingAddressForm) {
                sameAsShippingCheckbox.addEventListener('change', function() {
                    billingAddressForm.style.display = this.checked ? 'none' : 'block';
                });
                // Başlangıç durumu
                billingAddressForm.style.display = sameAsShippingCheckbox.checked ? 'none' : 'block';
            }

            // Butonlar (Olay Dinleyicisi Güncellemesi)
            if (btnToPayment) {
                btnToPayment.addEventListener('click', () => {
                    const isFormValid = validateShippingForm(); // Formu doğrula

                    if (isFormValid) { // Sadece form geçerliyse ilerle
                        navigateToStep('step-payment');
                    } else {
                        // Opsiyonel: Genel bir hata mesajı gösterilebilir veya ilk hatalı alana scroll yapılabilir
                        console.log("Shipping form has errors.");
                        // En üstteki hatalı alana odaklan (örnek)
                        const firstError = document.querySelector('#step-shipping .form-group.error input, #step-shipping .form-group.error select');
                        firstError?.focus();
                    }
                });
            }
            if (btnToReview) {
                // Önceki listener'ı kaldır (tekrar eklenmesini önlemek için)
                const oldHandler = window.navigateToReviewHandler; // Eski handler'ı referans al (varsa)
                if(oldHandler) btnToReview.removeEventListener('click', oldHandler);

                // Yeni handler fonksiyonu tanımla
                window.navigateToReviewHandler = function() { // Global scope'a ekleyerek referans alınabilir yapalım
                    const isPaymentFormValid = validatePaymentForm(); // Ödeme formunu doğrula

                    if (isPaymentFormValid) { // Sadece ödeme formu geçerliyse ilerle
                        populateReviewStep(); // Review adımını doldur
                        navigateToStep('step-review'); // Review adımına git
                    } else {
                        console.log("Payment/Billing form has errors.");
                         // En üstteki hatalı alana odaklan (örnek)
                        const firstError = document.querySelector('#step-payment .form-group.error input, #step-payment .form-group.error select');
                        firstError?.focus();
                    }
                }
                // Yeni listener'ı ekle
                btnToReview.addEventListener('click', window.navigateToReviewHandler);
            }
            if (btnPlaceOrder) {
                // Doğrudan form submit yerine click ile kontrol ediyoruz
                btnPlaceOrder.addEventListener('click', (event) => {
                     event.preventDefault(); // Form submit'i engelle
                     placeOrder();
                });
            }
            if (btnBackToShipping) {
                btnBackToShipping.addEventListener('click', () => navigateToStep('step-shipping'));
            }
            if (btnBackToPayment) {
                btnBackToPayment.addEventListener('click', () => navigateToStep('step-payment'));
            }

            // --- İlk Yükleme ---
            updateOrderSummary(); // Sayfa yüklendiğinde sipariş özetini doldur
            updateCartCount(cart); // Sayfa yüklendiğinde header sepet sayısını güncelle

            // --- Input Formatlama ---

            const expiryDateInput = document.getElementById('expiryDate');

            if (expiryDateInput) {
                expiryDateInput.addEventListener('input', function (e) {
                    let value = e.target.value.replace(/\D/g, ''); // Sadece rakamları al
                    let formattedValue = '';

                    if (value.length > 0) {
                        // İlk 2 rakamı al (Ay)
                        formattedValue += value.substring(0, 2);
                    }
                    if (value.length >= 2) {
                        // 2 rakamdan sonra otomatik / ekle
                        formattedValue += ' / ';
                        // Sonraki 2 rakamı al (Yıl)
                        formattedValue += value.substring(2, 4);
                    }

                    e.target.value = formattedValue;

                    // İsteğe bağlı: İmleci sona taşı (bazen formatlamada kayabilir)
                    // Bu kısım bazen mobil cihazlarda sorun çıkarabilir, dikkatli test edilmeli.
                    // e.target.setSelectionRange(formattedValue.length, formattedValue.length);

                     // Hata varsa ve kullanıcı yazmaya devam ediyorsa hatayı temizle
                     if (formattedValue.length > 0) {
                         clearError(e.target);
                     }
                });

                 // Odak kaybedildiğinde formatı tekrar kontrol et (örneğin eksik / varsa)
                 expiryDateInput.addEventListener('blur', function(e) {
                     let value = e.target.value.replace(/\D/g, '');
                     if (value.length === 4) { // Sadece 4 rakam girilmişse
                          e.target.value = value.substring(0, 2) + ' / ' + value.substring(2, 4);
                     }
                     // Burada geçerlilik kontrolü de yapılabilir (validatePaymentForm çağrılabilir)
                 });
            }

            // Opsiyonel: Kredi Kartı Numarası Formatlama (her 4 rakamda boşluk)
            const cardNumberInput = document.getElementById('cardNumber');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, ''); // Sadece rakamlar
                    let formattedValue = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) {
                            formattedValue += ' '; // Her 4 rakamda boşluk ekle
                        }
                        formattedValue += value[i];
                    }
                     // Maksimum uzunluk (örn: 16 hane + 3 boşluk = 19 karakter)
                     e.target.value = formattedValue.substring(0, 19);

                     if (formattedValue.length > 0) {
                         clearError(e.target);
                     }
                });
            }

            // Opsiyonel: CVC Formatlama (Sadece sayı ve maksimum 4 hane)
            const cvcInput = document.getElementById('cvc');
             if(cvcInput) {
                 cvcInput.addEventListener('input', function(e) {
                     let value = e.target.value.replace(/\D/g, '');
                     e.target.value = value.substring(0, 4); // Max 4 hane

                      if (value.length > 0) {
                         clearError(e.target);
                     }
                 });
             }

        }); // DOMContentLoaded Sonu
    </script>
</body>
</html>
